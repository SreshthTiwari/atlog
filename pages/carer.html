<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../styling/common.css" />
    <link rel="stylesheet" href="../styling/carer.css" />
    <link
      href="https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css"
      rel="stylesheet"
    />
    <link rel="icon" type="image/x-icon" href="../images/logo.png" />
    <title>Carer Info</title>
  </head>
  <body>
    <nav class="sidebar">
      <header>
        <div class="image-text">
          <span class="image">
            <img src="../images/logo.png" alt="" />
          </span>

          <div class="text logo-text">
            <span class="name">Backend</span>
          </div>
        </div>
      </header>

      <div class="menu-bar">
        <div class="menu">
          <ul class="menu-links">
            <li class="nav-link">
              <a href="../pages/home.html">
                <i class="bx bx-home-alt icon"></i>
                <span class="text nav-text">Home</span>
              </a>
            </li>

            <li class="nav-link">
              <a href="../pages/carer.html">
                <i class="bx bx-list-ul icon"></i>
                <span class="text nav-text">Carer Info</span>
              </a>
            </li>

            <li class="nav-link">
              <a href="../pages/students.html">
                <i class="bx bxs-school icon"></i>
                <span class="text nav-text">Student Info</span>
              </a>
            </li>

            <li class="nav-link">
              <a href="../pages/help.html">
                <i class="bx bx-question-mark icon"></i>
                <span class="text nav-text">Help</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="bottom-content">
          <li class="">
            <a href="../index.html" id="logoutlink">
              <i class="bx bx-log-out icon"></i>
              <span class="text nav-text">Logout</span>
            </a>
          </li>

          <li class="mode">
            <div class="sun-moon">
              <i class="bx bx-moon icon moon"></i>
              <i class="bx bx-sun icon sun"></i>
            </div>
            <span class="mode-text text">Dark mode</span>

            <div class="toggle-switch">
              <span class="switch"></span>
            </div>
          </li>
        </div>
      </div>
    </nav>

    <section class="home">
      <div class="main">
        <div class="addmenu" id="addmenu">
          <h3>Add Record</h3>
          <label for="Carer Name">Name</label>
          <input type="text" id="newname" />
          <br />
          <label for="Carer Route">Route</label>
          <input type="text" id="newroute" />
          <br />
          <label for="Access Code">Access Code</label>
          <input type="text" id="newcode" />
          <br />
          <button class="addmenubutton" onclick="confirmmm()">Confirm</button>
          <button class="addmenubutton" onclick="cancelll()">Close</button>
        </div>
        <div class="text">Manage Carers</div>
        <div class="route">
          Access Code:
          <!-- <input type="text" class="code" id="auntycode" value="12345" />
          <button onclick="changecode()">Enter</button> -->
          <select name="code" id="auntycode"></select>
          <button class="addrecord" onclick="addrecordddd()">Add Record</button>
        </div>
        <div class="info">
          <div class="containerr">
            <div class="carername" id="carername">Carer Name:</div>
            <br />
            <div class="code" id="route">Carer Route:</div>
            <br />
            <div class="access">
              <button onclick="changeaccess()" id="access">
                Revoke Access
              </button>
              <button onclick="deleterecordofaunty()">Delete Record</button>
            </div>
          </div>
        </div>
      </div>
    </section>
    <script type="module">
      import {
        getAuth,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-auth.js";

      import {
        ref,
        onValue,
      } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-database.js";
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-app.js";
      import {
        getDatabase,
        set,
        get,
        child,
        update,
        remove,
      } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-database.js";
      const firebaseConfig = {
        apiKey: "AIzaSyAKQ7x0iXdc9zPASPl8fe0Zy3w977sslwQ",
        authDomain: "schooltransportthingtest.firebaseapp.com",
        databaseURL:
          "https://schooltransportthingtest-default-rtdb.firebaseio.com",
        projectId: "schooltransportthingtest",
        storageBucket: "schooltransportthingtest.appspot.com",
        messagingSenderId: "1022909830472",
        appId: "1:1022909830472:web:14e6c0005a15bcfbed4f7d",
        measurementId: "G-9477HH598G",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const auth = getAuth();

      onAuthStateChanged(auth, (user) => {
        if (user) {
          console.log("user signed in");
        } else {
          console.log("user not signed in");
          window.location.href = "../index.html";
        }
      });

      var auntycode = document.getElementById("auntycode").value;
      // var auntycode = 12345;

      window.deleterecordofaunty = function deleterecordofaunty() {
        if (confirm("Are you sure?") == true) {
          remove(ref(db, "Carers/".concat(auntycode)));
          location.reload();
        }
      };

      let selectmenu = document.getElementById("auntycode");
      function addoptions(carers) {
        carers.forEach((carer) => {
          var newopt = document.createElement("option");
          newopt.value = carer["code"];
          newopt.innerHTML = carer["code"];
          selectmenu.appendChild(newopt);
        });
      }

      function firstaddtotable(carer) {
        let carernamehtml = document.getElementById("carername");
        let carerroutehtml = document.getElementById("route");
        let accessbutton = document.getElementById("access");

        carerroutehtml.innerHTML = "Carer Route: " + carer["routeNo"];
        carernamehtml.innerHTML = "Carer Name: " + carer["name"];

        console.log(carer);
        if (carer["access"] == true) {
          accessbutton.innerHTML = "Revoke Access";
        } else {
          accessbutton.innerHTML = "Enable Access";
        }
      }

      var accessenabled = true;

      function addtotable(carer) {
        let carernamehtml = document.getElementById("carername");
        let carerroutehtml = document.getElementById("route");
        let accessbutton = document.getElementById("access");
        console.log("works ehre");
        carerroutehtml.innerHTML = "Carer Route: " + carer[3];
        carernamehtml.innerHTML = "Carer Name: " + carer[2];
        console.log(carer);
        if (carer[0] == true) {
          accessbutton.innerHTML = "Revoke Access";
          console.log("this is working");
        } else {
          accessbutton.innerHTML = "Enable Access";
        }
      }

      window.changeaccess = function changeaccess() {
        let accessbutton = document.getElementById("access");

        var auntycode = document.getElementById("auntycode").value;

        if (confirm("Are you sure?") == true) {
          if (accessbutton.innerHTML == "Revoke Access") {
            update(ref(db, "Carers/".concat(auntycode)), {
              access: false,
            });
            location.reload();
          } else {
            update(ref(db, "Carers/".concat(auntycode)), {
              access: true,
            });
            location.reload();
          }
        }
      };

      function getdata() {
        const dbref = ref(db);

        auntycode = document.getElementById("auntycode").value;

        get(child(dbref, "Carers/".concat(auntycode))).then((snapshot) => {
          var othercarers = [];
          snapshot.forEach((childsnap) => {
            othercarers.push(childsnap.val());
          });
          console.log(othercarers);
          addtotable(othercarers);
          // addoptions(othercarers);
        });
        onValue(dbref, (snapshot) => {
          var carers = [];
          snapshot.forEach((childsnap) => {
            carers.push(childsnap.val());
          });
          console.log("Value changed");
          console.log(carers);
        });
      }

      function getoptionmenu() {
        const dbref = ref(db);

        auntycode = document.getElementById("auntycode").value;

        get(child(dbref, "Carers/".concat(auntycode))).then((snapshot) => {
          var carers = [];
          snapshot.forEach((childsnap) => {
            carers.push(childsnap.val());
          });
          console.log(carers);
          addoptions(carers);
          firstaddtotable(carers[0]);
        });
      }

      function start() {
        // getdata();
        getoptionmenu();
      }

      var addmenu = document.getElementById("addmenu");

      window.addrecordddd = function addrecordddd() {
        addmenu.style.display = "block";
        console.log("Add record");
      };

      window.confirmmm = function confirmmm() {
        var newname = document.getElementById("newname").value;
        var newcode = document.getElementById("newcode").value;
        var newroute = document.getElementById("newroute").value;

        set(ref(db, "Carers/".concat(newcode)), {
          access: true,
          code: newcode,
          name: newname,
          routeNo: newroute,
        });

        alert("Successfully added record");
        addmenu.style.display = "none";
        location.reload();
        console.log("done");
      };

      window.cancelll = function cancelll() {
        addmenu.style.display = "none";
      };

      window.changecode = function changecode() {
        auntycode = document.getElementById("auntycode").value;
        getdata();
      };

      selectmenu.onchange = getdata;
      window.onload = start;

      logoutlink.addEventListener("click", function () {
        const auth = getAuth();
        signOut(auth)
          .then(() => {})
          .catch((error) => {
            alert("error");
          });
      });

      const body = document.querySelector("body"),
        img = body.querySelector(".image"),
        sidebar = body.querySelector("nav"),
        modeSwitch = body.querySelector(".toggle-switch"),
        modeText = body.querySelector(".mode-text");

      modeSwitch.addEventListener("click", () => {
        body.classList.toggle("dark");

        if (body.classList.contains("dark")) {
          modeText.innerText = "Light mode";
          img.innerHTML = '<img src="../images/darklogo.png" alt="" />';
        } else {
          modeText.innerText = "Dark mode";
          img.innerHTML = '<img src="../images/logo.png" alt="" />';
        }
      });
    </script>
  </body>
</html>
